<!DOCTYPE html>
<html>
<head>
	<title>Tree node relatioship</title>
</head>
<style type="text/css">
	#lDiv, #rDiv{
		overflow: auto;
	}
</style>
<body>
	<div style="width: 100%; min-width: 550px; border: 1px solid black;">
		<div id="lDiv" onscroll="scrollFunc()" style="float: left; width: calc((100% - 200px) / 2 - 1px); height: 300px;">
		</div>
		<div id="relation" style="float: left; border-left: 1px solid black; border-right: 1px solid black; width: 200px;">
			<canvas id="myCanvas" width="200" height="300"></canvas>
		</div>
		<div id="rDiv" onscroll="scrollFunc()" style="float: left; width: calc((100% - 200px) / 2 - 1px); height: 300px;">
		</div>
		<div style="clear: both;"></div>
	</div>
	<button onclick="ResetClicked()">Reset</button><br>
<!-- <p>&rarr;<i class="arrow right"></i></p> -->
<textarea id="lTreeJson" rows="15" style="float: left; width: calc((100% - 200px) / 2 - 10px);">
[
  {
    "id": 1, "name": "text_1", "context": "context_1", "children": [
      {"id": 2, "name": "text_2", "context": "context_2", "children": [
        {"id": 4, "name": "text_4", "context": "context_4", "children": []},
        {"id": 5, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 3, "name": "text_3", "context": "context_3"},
      {"id": 6, "name": "text_3", "context": "context_3"}
    ]
  },
  {
    "id": 11, "name": "text_1", "context": "context_1", "children": [
      {"id": 12, "name": "text_2", "context": "context_2", "children": [
        {"id": 14, "name": "text_4", "context": "context_4", "children": []},
        {"id": 15, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 13, "name": "text_3", "context": "context_3"},
      {"id": 16, "name": "text_3", "context": "context_3"}
    ]
  },
  {
    "id": 21, "name": "text_1", "context": "context_1", "children": [
      {"id": 22, "name": "text_2", "context": "context_2", "children": [
        {"id": 24, "name": "text_4", "context": "context_4", "children": []},
        {"id": 25, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 23, "name": "text_3", "context": "context_3"},
      {"id": 26, "name": "text_3", "context": "context_3"}
    ]
  }
]

</textarea>
<textarea id="relationJson" rows="15" style="float: left; width: 200px;">
[
  {"lSide":1, "rSide":1},
  {"lSide":1, "rSide":2},
  {"lSide":3, "rSide":4},
  {"lSide":4, "rSide":5},
  {"lSide":6, "rSide":5},
  {"lSide":6, "rSide":3},
  {"lSide":26, "rSide":3}
]

</textarea>
<textarea id="rTreeJson" rows="15" style="float: left; width: calc((100% - 200px) / 2 - 10px);">
[
  {
    "id": 1, "name": "text_1", "context": "context_1", "children": [
      {"id": 2, "name": "text_2", "context": "context_2", "children": [
        {"id": 4, "name": "text_4", "context": "context_4", "children": []},
        {"id": 5, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 3, "name": "text_3", "context": "context_3"},
      {"id": 6, "name": "text_3", "context": "context_3"}
    ]
  },
  {
    "id": 11, "name": "text_1", "context": "context_1", "children": [
      {"id": 12, "name": "text_2", "context": "context_2", "children": [
        {"id": 14, "name": "text_4", "context": "context_4", "children": []},
        {"id": 15, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 13, "name": "text_3", "context": "context_3"},
      {"id": 16, "name": "text_3", "context": "context_3"}
    ]
  },
  {
    "id": 21, "name": "text_1", "context": "context_1", "children": [
      {"id": 22, "name": "text_2", "context": "context_2", "children": [
        {"id": 24, "name": "text_4", "context": "context_4", "children": []},
        {"id": 25, "name": "text_5", "context": "context_5", "children": []}
      ]},
      {"id": 23, "name": "text_3", "context": "context_3"},
      {"id": 26, "name": "text_3", "context": "context_3"}
    ]
  }
]

</textarea>
<div style="clear: both;"></div>
<br>
<h3>Usage</h3>
<p>1. Press "Reset" button.</p>
<p>&nbsp&nbsp Then you can see the demo graph.</p>
<p>2. Scroll left or right view.</p>
<p>&nbsp&nbsp Then you can see relation arrows moved according scroll.</p>
<p>3. Select relation arrow and press "Delete" key.</p>
<p>&nbsp&nbsp Then you can see arrow is selected with red color and removed.</p>
</body>
<link rel="stylesheet" type="text/css" href="library/treeView.css">
<script type="text/javascript" src="library/jquery.min.js"></script>
<script type="text/javascript" src="library/treeView.js"></script>
<script type="text/javascript" src="library/treeRelation.js"></script>
<script type="text/javascript">
	var lTree = new RelationTreeView("lDiv");
	var rTree = new RelationTreeView("rDiv");
	var cRelation = new TreeRelationControl("myCanvas");
	var canvas = document.getElementById("myCanvas");

	var rJson;
	var relationJson;
	var lJson;

	canvas.addEventListener('click', function(event){
		var left = this.offsetLeft;
		var top = this.offsetTop;
		var x = event.pageX - left;
		var y = event.pageY - top;
		console.log(x + ":" + y);
		cRelation.activeRelation(x, y);
	});
	document.addEventListener('keyup', function(event){
		if( event.key == "Delete" && $(canvas).focus()){
			var index = cRelation.removeRelation();
			if( index != -1)
				relationJson.splice(index, 1);
		}
	});
	function scrollFunc(){
		reDrawRelation();
	}
	function reDrawRelation(){
		try{
			// var relationJson = JSON.parse($("#relationJson").val());
			var lTop = $("#lDiv").scrollTop();
			var rTop = $("#rDiv").scrollTop();
			var arrRelations = [];
			for( var i = 0; i < relationJson.length; i++){
				var relation = relationJson[i];
				var lVal = lTree.getTopPosition(relation.lSide);
				var rVal = rTree.getTopPosition(relation.rSide);
				var lPos = lVal * 22 + 11 - lTop;
				var rPos = rVal * 22 + 11 - rTop;
				arrRelations.push({lPos:lPos, rPos:rPos});
			}
			cRelation.setRelations(arrRelations);
			cRelation.drawRelations();
		} catch(e){
			alert("error relation json format\n" + e);
		}
	}
	function ResetClicked(){
		try{
			lJson = JSON.parse($("#lTreeJson").val());
			lTree.setNodes(lJson);
			lTree.drawNodes();
		}catch(e){
			alert("error left json format\n" + e);
		}
		try{
			rJson = JSON.parse($("#rTreeJson").val());
			rTree.setNodes(rJson);
			rTree.drawNodes();
		}catch(e){
			alert("error right json format\n" + e);
		}
		try{
			relationJson = JSON.parse($("#relationJson").val());
			reDrawRelation();
		} catch(e){
			alert("error relation json format\n" + e);
		}
		// reDrawRelation();
	}

	var selectedItem;
	var selectedId = -1;
	function mouseOver(_this){
		if( $(selectedItem).parent().parent().parent().attr("id") == $(_this).parent().parent().parent().attr("id"))
			return;

		if( selectedItem ){
			var id = $(_this).find("td").eq(0).attr("id");
			var lPos = lTree.getTopPosition(selectedId) * 22 + 11 - $("#lDiv").scrollTop();
			var rPos = rTree.getTopPosition(id) * 22 + 11 - $("#rDiv").scrollTop();
			cRelation.setTemplate({lPos:lPos, rPos:rPos});
			cRelation.drawRelations();
		}
		$(_this).css("background-color", "#cdf");
	}
	function mouseLeave(_this){
		if( selectedItem == _this)
			return;
		$(_this).css("background-color", "white");
	}
	function mouseDown(_this){
		selectedItem = _this;
		var id = $(_this).find("td").eq(0).attr("id");
		selectedId = id;
		console.log(id);
	}
	function mouseUp(_this){
		$("#lDiv table tr").css("background-color", "white");
		$("#rDiv table tr").css("background-color", "white");
		if( $(selectedItem).parent().parent().parent().attr("id") == $(_this).parent().parent().parent().attr("id")){
			selectedItem = null;
			selectedId = -1;
			return;
		}
		var id = $(_this).find("td").eq(0).attr("id");
		console.log(id);
		relationJson.push({lSide:selectedId, rSide:id});
		cRelation.setTemplate();
		reDrawRelation();
		selectedItem = null;
		selectedId = -1;
	}
</script>
</html>